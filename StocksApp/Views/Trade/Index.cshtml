@model StocksApp.Models.StockTrade
@inject IConfiguration configuration
@{
    ViewBag.Title = "Trade";
}

<div class="box trading-panel">
    <div class="flex trading-panel-flex">
        <div id="stock-price-panel">
            <div class="stock">
                <h1 class="stock-title"><span id="StockName">@Model.StockName</span> (<span id="StockSymbol">@Model.StockSymbol</span>)</h1>
                <h2><small>$</small><span class="price" id="StockPrice">@Model.Price</span></h2>
            </div>
        </div>
    </div>
</div>

<script>
    const token = "@configuration["FinnhubToken"]"; //This is not safe since it is exposed to the client. It should be stored in the server and retrieved via an API call.
    const socket = new WebSocket(`wss://ws.finnhub.io?token=${token}`);
    const symbol = "@Model.StockSymbol";
    const stockPrice = document.getElementById('StockPrice');

    socket.addEventListener('open', (event) => {
        socket.send(JSON.stringify({ 'type': 'subscribe', 'symbol': symbol }));
    });
    
    socket.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'trade') {
            const price = data.data[0].p;
            stockPrice.textContent = price.toFixed(2);
        }
    });

    window.addEventListener('beforeunload', (event) => {
        socket.close();
    });
</script>